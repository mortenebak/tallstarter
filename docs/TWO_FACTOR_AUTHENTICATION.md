# Two-Factor Authentication (2FA)

This starter kit includes built-in support for Two-Factor Authentication (2FA) using Time-based One-Time Passwords (TOTP), compatible with popular authenticator apps like Google Authenticator, Authy, and 1Password.

## Features

- **TOTP-based authentication** using the industry-standard algorithm
- **QR code generation** for easy setup
- **Manual entry option** for authenticator apps
- **Recovery codes** for account recovery if you lose access to your authenticator device
- **Seamless integration** with the existing authentication flow
- **User-friendly interface** built with Flux UI components

## User Guide

### Enabling Two-Factor Authentication

1. Log in to your account
2. Navigate to **Settings** > **Two-Factor Authentication**
3. Click **Enable Two-Factor Authentication**
4. Scan the QR code with your authenticator app (Google Authenticator, Authy, 1Password, etc.)
   - Alternatively, you can manually enter the setup key shown below the QR code
5. Enter the 6-digit code from your authenticator app to confirm
6. **Save your recovery codes** in a secure location (password manager recommended)

### Logging In with 2FA

1. Enter your email and password as usual
2. You'll be redirected to the two-factor authentication challenge
3. Open your authenticator app and enter the current 6-digit code
4. Click **Verify** to complete login

### Using Recovery Codes

If you lose access to your authenticator device:

1. On the two-factor challenge screen, click **Use recovery code**
2. Enter one of your recovery codes
3. Click **Verify**
4. **Important:** Each recovery code can only be used once

After logging in with a recovery code, you should:
- Navigate to Settings > Two-Factor Authentication
- Generate new recovery codes
- Consider disabling and re-enabling 2FA with a new device

### Managing Recovery Codes

To view or regenerate your recovery codes:

1. Navigate to **Settings** > **Two-Factor Authentication**
2. Click **Show Recovery Codes** to view your current codes
3. Click **Regenerate Recovery Codes** to generate a new set
   - **Warning:** This will invalidate all existing recovery codes

### Disabling Two-Factor Authentication

1. Navigate to **Settings** > **Two-Factor Authentication**
2. Click **Disable Two-Factor Authentication**
3. 2FA will be immediately disabled for your account

## Technical Details

### Database Schema

The following columns are added to the `users` table:

- `two_factor_secret` (text, nullable, encrypted) - Stores the TOTP secret
- `two_factor_recovery_codes` (text, nullable, encrypted) - Stores recovery codes
- `two_factor_confirmed_at` (timestamp, nullable) - Marks when 2FA was confirmed

### Authentication Flow

1. User logs in with email/password
2. System checks if user has 2FA enabled (`hasTwoFactorEnabled()`)
3. If yes, user is logged out and redirected to 2FA challenge
4. User enters TOTP code or recovery code
5. System verifies the code
6. If valid, user is logged in and redirected to dashboard

### Security Considerations

- **Secrets are encrypted** - Both the TOTP secret and recovery codes are encrypted before storage
- **Rate limiting** - The 2FA challenge is rate-limited to prevent brute force attacks (5 attempts per IP)
- **Recovery codes** - Generated using cryptographically secure random bytes
- **One-time use** - Recovery codes are removed after use
- **Session security** - Login session data is stored temporarily and cleared after successful authentication

## Development

### Dependencies

This feature uses the following package:

- `pragmarx/google2fa-qrcode` - For TOTP generation and QR code creation

### Key Files

**Models:**
- `app/Models/User.php` - User model with 2FA methods

**Livewire Components:**
- `app/Livewire/Settings/TwoFactor.php` - Settings page component
- `app/Livewire/Auth/TwoFactorChallenge.php` - Login challenge component
- `app/Livewire/Auth/Login.php` - Updated login component

**Views:**
- `resources/views/livewire/settings/two-factor.blade.php`
- `resources/views/livewire/auth/two-factor-challenge.blade.php`

**Routes:**
- `routes/web.php` - Settings route
- `routes/auth.php` - Challenge route

**Migrations:**
- `database/migrations/2026_01_08_105500_add_two_factor_columns_to_users_table.php`

### Testing

Run the 2FA tests:

```bash
php artisan test --filter=TwoFactor
```

Or run all tests:

```bash
php artisan test
```

## FAQ

**Q: What authenticator apps are compatible?**

A: Any TOTP-compatible authenticator app works, including:
- Google Authenticator
- Authy
- 1Password
- Microsoft Authenticator
- LastPass Authenticator

**Q: How many recovery codes are generated?**

A: 8 recovery codes are generated by default.

**Q: Can I use the same authenticator app on multiple devices?**

A: Yes, but you'll need to scan the QR code or enter the setup key on each device when initially setting up 2FA.

**Q: What happens if I lose my phone and recovery codes?**

A: An administrator can disable 2FA for your account by directly modifying the database or through an admin panel (if implemented).

**Q: Is 2FA required for all users?**

A: No, 2FA is optional. Each user can choose to enable or disable it for their own account.

## Future Enhancements

Potential improvements that could be added:

- SMS-based 2FA as an alternative to TOTP
- WebAuthn/FIDO2 support for hardware security keys
- Admin ability to enforce 2FA for all users
- Backup authentication methods
- 2FA setup during registration
- Trust this device option (skip 2FA for 30 days)
